FROM python:3.11

# Metadata
LABEL maintainer="AI Game Team"
LABEL description="ComfyUI with Stable Diffusion for AI Image Generation - Production Ready"
LABEL version="1.0"

# Build argument for conditional model download
ARG DOWNLOAD_MODELS=true

# Install only missing dependencies (full image has most tools already)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Clone ComfyUI (pinned to stable commit for reproducibility)
RUN git clone https://github.com/comfyanonymous/ComfyUI.git . && \
    git checkout 9e6a75c49e1c61a4f1d7a94d5f9c8e5a8f7e9b2c || git checkout master

# Install Python dependencies
# Using CPU-only PyTorch for cross-platform compatibility
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir -r requirements.txt

# Install additional packages for API support
RUN pip install --no-cache-dir \
    aiohttp \
    websockets \
    pillow \
    safetensors

# Create directory structure
RUN mkdir -p \
    models/checkpoints \
    models/loras \
    models/vae \
    models/clip \
    output \
    input \
    temp \
    shared-images

# Download models conditionally (can be skipped if using volumes)
RUN if [ "$DOWNLOAD_MODELS" = "true" ]; then \
    echo "ðŸ“¦ Downloading AI models (~5GB total)..." && \
    echo "â³ This will take 10-30 minutes depending on your internet speed..." && \
    \
    # SD 1.5 Base Model (~4GB)
    echo "1/3 Downloading Stable Diffusion 1.5 model (~4GB)..." && \
    wget --progress=bar:force:noscroll --timeout=60 --tries=3 \
        https://huggingface.co/runwayml/stable-diffusion-v1-5/resolve/main/v1-5-pruned.safetensors \
        -O models/checkpoints/v1-5-pruned.safetensors && \
    echo "âœ… SD 1.5 model downloaded" && \
    \
    # LCM LoRA for fast generation (~200MB)
    echo "2/3 Downloading LCM LoRA (~200MB)..." && \
    wget --progress=bar:force:noscroll --timeout=60 --tries=3 \
        https://huggingface.co/latent-consistency/lcm-lora-sdv1-5/resolve/main/pytorch_lora_weights.safetensors \
        -O models/loras/lcm-lora-sdv1-5.safetensors && \
    echo "âœ… LCM LoRA downloaded" && \
    \
    # VAE Model (~330MB) - Improves image quality
    echo "3/3 Downloading VAE model (~330MB)..." && \
    wget --progress=bar:force:noscroll --timeout=60 --tries=3 \
        https://huggingface.co/stabilityai/sd-vae-ft-mse-original/resolve/main/vae-ft-mse-840000-ema-pruned.safetensors \
        -O models/vae/vae-ft-mse-840000-ema-pruned.safetensors && \
    echo "âœ… VAE model downloaded" && \
    \
    echo "âœ… All models downloaded successfully!" && \
    ls -lh models/checkpoints/ models/loras/ models/vae/; \
else \
    echo "âš ï¸ Skipping model download (DOWNLOAD_MODELS=false)"; \
    echo "âš ï¸ Ensure models are provided via volumes"; \
fi

# Set environment variables for optimization
ENV PYTORCH_ENABLE_MPS_FALLBACK=1
ENV PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0
ENV COMFYUI_MODEL_CACHE=/app/models

# Expose ComfyUI port
EXPOSE 8188

# Create optimized startup script with proper error handling
RUN printf '#!/bin/bash\nset -e\n\necho ""\necho "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"\necho "â•‘   ðŸŽ¨ ComfyUI AI Image Generation      â•‘"\necho "â•‘   Starting service...                  â•‘"\necho "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"\necho ""\n\n# Verify models exist\necho "ðŸ“¦ Checking models..."\nif [ ! -f "models/checkpoints/v1-5-pruned.safetensors" ]; then\n    echo "âŒ ERROR: SD 1.5 model not found!"\n    echo "Please rebuild with DOWNLOAD_MODELS=true"\n    exit 1\nfi\n\nif [ ! -f "models/loras/lcm-lora-sdv1-5.safetensors" ]; then\n    echo "âš ï¸  WARNING: LCM LoRA not found - generation will be slower"\nfi\n\necho "âœ… Models verified"\necho ""\necho "ðŸ“Š Model sizes:"\nls -lh models/checkpoints/ | grep -v "^total" | awk '"'"'{print "  ", $9, "-", $5}'"'"'\nls -lh models/loras/ | grep -v "^total" | awk '"'"'{print "  ", $9, "-", $5}'"'"' 2>/dev/null || true\nls -lh models/vae/ | grep -v "^total" | awk '"'"'{print "  ", $9, "-", $5}'"'"' 2>/dev/null || true\necho ""\necho "ðŸš€ Starting ComfyUI on http://0.0.0.0:8188"\necho "ðŸ”— API available at http://localhost:8188/system_stats"\necho ""\n\npython main.py --listen 0.0.0.0 --port 8188 --cpu\n' > /app/start.sh && \
    chmod +x /app/start.sh

# Healthcheck - extended start period for model loading
HEALTHCHECK --interval=30s --timeout=10s --start-period=180s --retries=5 \
    CMD curl -f http://localhost:8188/system_stats || exit 1

# Start ComfyUI
CMD ["/app/start.sh"]
